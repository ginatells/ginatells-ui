trigger:
  branches:
    include:
    - master

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: AWS
  - name: DOCKER_REPOSITORY
    value: 'ginatells-ui'

stages:
- stage: Build
  jobs:
    - job: Build
      steps:
      - script: echo Building!
      - task: Docker@2
        displayName: Build image
        inputs:
          repository: $(DOCKER_REPOSITORY)
          command: build
          Dockerfile: Dockerfile
          tags: |
            release
      - task: ECRPushImage@1
        displayName: Push image to ECR
        inputs:
          awsCredentials: 'AWS'
          regionName: 'us-west-2'
          imageSource: 'imagename'
          sourceImageName: $(DOCKER_REPOSITORY)
          sourceImageTag: 'release'
          repositoryName: $(DOCKER_REPOSITORY)
          pushTag: 'release'

- stage: Test
  jobs:
    - job: UnitTests
      displayName: Unit Tests
      steps:
      - script: echo Unit Testing!
    - job: UITests
      displayName: UI Tests
      steps:
      - script: echo UI Testing!

- stage: Deploy
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/release'))
  jobs:
    - job: Deploy
      steps:
      - script: echo Deploying the code!
      - task: AWSCLI@1
        inputs:
          awsCredentials: 'AWS'
          regionName: 'us-west-2'
          awsCommand: 'ec2'
          awsSubCommand: 'reboot-instances'
          awsArguments: '--instance-ids i-02592d4ea12836306'
          failOnStandardError: true
      